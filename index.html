<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>C-Spine AI Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    
    <style>
        /* 1. ê¸°ë³¸ ì„¤ì •: ê²€ì€ ë°°ê²½, ìŠ¤í¬ë¡¤ ë°©ì§€ */
        body { margin: 0; background-color: black; overflow: hidden; font-family: 'Suit', sans-serif; }
        
        /* 2. ì»¨í…Œì´ë„ˆ: í™”ë©´ ê½‰ ì±„ìš°ê¸° */
        .container { position: relative; width: 100vw; height: 100vh; }

        /* 3. ë¹„ë””ì˜¤ & ìº”ë²„ìŠ¤ ê³µí†µ ì„¤ì • (ì™„ë²½í•œ ê²¹ì¹¨) */
        video, canvas { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            object-fit: cover; /* í™”ë©´ ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ì›€ */
            transform: scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
        }
        
        video { z-index: 0; } /* ë’¤ */
        canvas { z-index: 1; } /* ì• */

        /* 4. UI íŒ¨ë„ (ë§¨ ì•) */
        #ui-layer {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px; z-index: 10; text-align: center;
        }

        .status-box {
            background: rgba(0, 0, 0, 0.65); 
            padding: 20px; 
            border-radius: 16px;
            border: 3px solid #555; /* ì´ˆê¸° í…Œë‘ë¦¬ */
            backdrop-filter: blur(8px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transition: border-color 0.2s ease;
        }

        #main-msg { 
            font-size: 1.6rem; font-weight: 900; color: white; 
            display: block; margin-bottom: 5px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        
        #sub-msg {
            font-size: 1.1rem; color: #ddd; font-weight: 500;
            display: block; margin-bottom: 15px;
        }

        /* ìˆ˜ì¹˜ ë°ì´í„° ê·¸ë¦¬ë“œ */
        .metrics-grid { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px; border-top: 1px solid rgba(255,255,255,0.2); 
            padding-top: 15px; 
        }
        
        .metric-label { font-size: 0.85rem; color: #bbb; display: block; margin-bottom: 4px; }
        .metric-val { font-size: 1.3rem; font-weight: bold; color: white; font-family: monospace; }

    </style>
</head>
<body>
    <div class="container">
        <div id="ui-layer">
            <div class="status-box" id="status-bg">
                <span id="main-msg">AI ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</span>
                <span id="sub-msg">ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”</span>
                
                <div class="metrics-grid">
                    <div><span class="metric-label">ì… ë²Œë¦¼ (Open)</span><span class="metric-val" id="val-mouth">-</span></div>
                    <div><span class="metric-label">ìˆ™ì„ê° (Pitch)</span><span class="metric-val" id="val-pitch">-</span></div>
                    <div><span class="metric-label">íšŒì „ (Yaw)</span><span class="metric-val" id="val-yaw">-</span></div>
                </div>
            </div>
        </div>

        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <script type="module">
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const ctx = canvasElement.getContext('2d');
        
        // UI ìš”ì†Œ ì—°ê²°
        const statusBg = document.getElementById('status-bg');
        const mainMsg = document.getElementById('main-msg');
        const subMsg = document.getElementById('sub-msg');
        const valMouth = document.getElementById('val-mouth');
        const valPitch = document.getElementById('val-pitch');
        const valYaw = document.getElementById('val-yaw');

        function onResults(results) {
            // [í•µì‹¬ 1] ë§¤ í”„ë ˆì„ë§ˆë‹¤ ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ í˜„ì¬ ì°½ í¬ê¸°ë¡œ ê°•ì œ ë™ê¸°í™” (ëª¨ë°”ì¼ í˜¸í™˜ì„± 100%)
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            
            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // ì–¼êµ´ ì¸ì‹ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
            if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                mainMsg.innerText = "ì–¼êµ´ ì°¾ëŠ” ì¤‘...";
                mainMsg.style.color = "#FFD700"; // Gold
                statusBg.style.borderColor = "#FFD700";
                subMsg.innerText = "ì¹´ë©”ë¼ ì •ë©´ì„ ë´ì£¼ì„¸ìš”";
                return;
            }

            const landmarks = results.multiFaceLandmarks[0];

            // [í•µì‹¬ 2] ì¢Œí‘œ ë³€í™˜ í•¨ìˆ˜ (0 ì²˜ë¦¬ë¡œ NaN ë°©ì§€)
            const toPixel = (idx) => {
                return { 
                    x: landmarks[idx].x * canvasElement.width, 
                    y: landmarks[idx].y * canvasElement.height 
                };
            };
            
            // ê±°ë¦¬ ê³„ì‚° í—¬í¼
            const dist = (p1, p2) => Math.hypot(p1.x - p2.x, p1.y - p2.y);

            // --- ë°ì´í„° ê³„ì‚° ---
            const p_top = toPixel(10); const p_bottom = toPixel(152); // ì–¼êµ´ ì„¸ë¡œ
            const p_nose = toPixel(1); // ì½”
            const p_ulip = toPixel(13); const p_llip = toPixel(14); // ì…ìˆ 
            const p_lear = toPixel(234); const p_rear = toPixel(454); // ê·€

            // 1. ì… ë²Œë¦¼ (Mouth)
            const faceHeight = dist(p_top, p_bottom) || 1; // 0 ë‚˜ëˆ„ê¸° ë°©ì§€
            const mouthRatio = (dist(p_ulip, p_llip) / faceHeight) * 100;

            // 2. íšŒì „ (Yaw)
            const leftDist = dist(p_nose, p_lear);
            const rightDist = dist(p_nose, p_rear) || 1;
            const yawRatio = leftDist / rightDist;

            // 3. ìˆ™ì„ê° (Pitch) - ìƒëŒ€ ì¢Œí‘œ ì‚¬ìš©
            const noseY = landmarks[1].y;
            const earsY = (landmarks[234].y + landmarks[454].y) / 2;
            const pitchDiff = (noseY - earsY) * 100;

            // --- íŒë… ê¸°ì¤€ (ì„ìƒ ìˆ˜ì¹˜ ë°˜ì˜) ---
            const TH_MOUTH = 7.0; 
            const YAW_MIN = 0.60; const YAW_MAX = 1.40;
            const PITCH_MIN = 3.0; const PITCH_MAX = 15.0;

            // --- ìƒíƒœ íŒë‹¨ ë¡œì§ ---
            let isReady = false;
            let msg = "";
            let guideColor = "";

            if (yawRatio < YAW_MIN) {
                msg = "ê³ ê°œë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ğŸ‘‰"; guideColor = "#FF0055"; // Hot Pink
            } else if (yawRatio > YAW_MAX) {
                msg = "ğŸ‘ˆ ê³ ê°œë¥¼ ì™¼ìª½ìœ¼ë¡œ"; guideColor = "#FF0055";
            } else if (pitchDiff < PITCH_MIN) {
                msg = "í„±ì„ ë‹¹ê¸°ì„¸ìš” (Down) â†“"; guideColor = "#FF0055";
            } else if (pitchDiff > PITCH_MAX) {
                msg = "í„±ì„ ë“œì„¸ìš” (Up) â†‘"; guideColor = "#FF0055";
            } else if (mouthRatio < TH_MOUTH) {
                msg = "ì…ì„ ë” í¬ê²Œ 'ì•„~' ğŸ˜®"; guideColor = "#FF9900"; // Orange
            } else {
                isReady = true;
                msg = "ì™„ë²½í•œ í¬ì§€ì…˜ì…ë‹ˆë‹¤"; guideColor = "#00FF00"; // Neon Green
            }

            // --- UI ì—…ë°ì´íŠ¸ ---
            mainMsg.innerText = isReady ? "ì´¬ì˜ ê°€ëŠ¥ (READY)" : "ì¡°ì • í•„ìš”";
            mainMsg.style.color = guideColor;
            subMsg.innerText = msg;
            statusBg.style.borderColor = guideColor;

            // ìˆ˜ì¹˜ í‘œì‹œ (NaN ë°©ì–´ ì½”ë“œ)
            valMouth.innerText = isNaN(mouthRatio) ? "0.0" : mouthRatio.toFixed(1);
            valPitch.innerText = isNaN(pitchDiff) ? "0.0" : pitchDiff.toFixed(1);
            valYaw.innerText = isNaN(yawRatio) ? "0.00" : yawRatio.toFixed(2);

            // ìˆ˜ì¹˜ë³„ ìƒ‰ìƒ
            valMouth.style.color = (mouthRatio < TH_MOUTH) ? "#FF5555" : "#00FF00";
            valPitch.style.color = (pitchDiff < PITCH_MIN || pitchDiff > PITCH_MAX) ? "#FF5555" : "#00FF00";
            valYaw.style.color = (yawRatio < YAW_MIN || yawRatio > YAW_MAX) ? "#FF5555" : "#00FF00";

            // --- [í•µì‹¬ 3] ê³ ì‹œì¸ì„± ê·¸ë¦¬ê¸° (High Visibility Drawing) ---
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            
            // 1. ì‹­ìì„  (ë‘ê»ê²Œ)
            ctx.lineWidth = 5; 
            ctx.strokeStyle = guideColor;
            
            ctx.beginPath();
            ctx.moveTo(p_top.x, p_top.y); ctx.lineTo(p_bottom.x, p_bottom.y); // ì„¸ë¡œ
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(p_lear.x, p_lear.y); ctx.lineTo(p_rear.x, p_rear.y); // ê°€ë¡œ
            ctx.stroke();

            // 2. ì¤‘ìš” í¬ì¸íŠ¸ ì  ì°ê¸° (ì½”, ì…ìˆ )
            const drawDot = (p, color, size) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, size, 0, 2*Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                // í°ìƒ‰ í…Œë‘ë¦¬ë¡œ ê°€ì‹œì„± í™•ë³´
                ctx.lineWidth = 2;
                ctx.strokeStyle = "white";
                ctx.stroke();
            };

            drawDot(p_nose, guideColor, 12); // ì½” (ì™•ì )
            drawDot(p_ulip, "yellow", 6);   // ìœ—ì…ìˆ 
            drawDot(p_llip, "yellow", 6);   // ì•„ë«ì…ìˆ 
        }

        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        faceMesh.onResults(onResults);

        // [í•µì‹¬ 4] ì¹´ë©”ë¼ ì„¤ì •: ëª¨ë°”ì¼ í˜¸í™˜ì„±ì„ ìœ„í•´ í•´ìƒë„ ê°•ì œ ì œê±°
        const camera = new Camera(videoElement, {
            onFrame: async () => { await faceMesh.send({image: videoElement}); },
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: "user"
        });
        camera.start();
    </script>
</body>
</html>
